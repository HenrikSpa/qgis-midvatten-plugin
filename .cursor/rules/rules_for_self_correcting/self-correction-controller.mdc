# Self-Correction Controller

## Purpose
This rule orchestrates the self-correction workflow, which aims to continuously improve system reliability by generating high-quality prevention rules when the agent introduces structural or recurring bugs.

The controller is responsible for:
- Detecting when the system generates a bug.
- Analyzing the root cause of the failure.
- Triggering new rule generation when a reusable rule can prevent recurrence.
- Ensuring that rules are written in the proper folder: `.cursor/rules/self_corrected_rules`.

## Folder Write Restriction (STRICT)
- **Self-correction rules** must only be created in:
  `.cursor/rules/self_corrected_rules`
- **Do not modify rules in** `.cursor/rules/rules_for_self_correcting` unless needed for self-correction processes.
- **Do not modify** `.cursor/rules/self_corrected_rules` directly. It is reserved for generated rules, and self-correction-related rules should remain in the `rules_for_self_correcting` folder.

---

## Self-Correction Trigger Conditions
This workflow is triggered when all of the following are true:

1. The bug was generated by code previously produced by the agent.
2. The issue is **structural** (not a typo, format error, or style issue).
3. The bug indicates a **reasoning failure**, an **incorrect assumption**, a **missing constraint**, or an **architectural mistake**.
4. The fix required **non-trivial reasoning** (i.e., the fix cannot be trivial or based on user-side interventions).
5. Confidence that a reusable rule could have prevented the bug recurrence is **≥ 70%**.

If **any** condition fails, **do not generate a rule**.

---

## Structured Reflection (MANDATORY)
Before generating a rule, the following analysis must be completed:

### SELF-CORRECTION ANALYSIS

- **Original Goal**:
- **What I Generated**:
- **Observed Failure**:
- **Root Cause Category** (Check all that apply):
  - [ ] Missing constraint
  - [ ] Incorrect assumption
  - [ ] Over-generalization
  - [ ] Architecture mistake
  - [ ] Ignored existing rule
  - [ ] Incomplete edge case handling
- **Was This Preventable by a General Rule?** (Yes/No)
- **Has Similar Failure Happened Before?** (Yes/No)
- **Recurrence Likelihood**: Low / Medium / High
- **Estimated Prevention Confidence (%)**:
- **Proposed Generalized Prevention Principle**: (Describe the high-level rule)

If confidence is **less than 70%**, **STOP**. Do not generate a rule.

---

## Recurring Bug Detector
A new rule may only be created if one or more of the following conditions apply:

- The root cause of the bug has been observed **≥ 2 times**.
- The bug involves critical issues such as **architecture**, **security**, **validation**, or **data integrity**.
- The failure violates an **existing core rule** or requires a **major architectural change**.
- The **severity** of the bug is **Medium or High**.

If none of these conditions are met, **log the insight** but do not generate a new rule.

---

## Rule Creation Process
If all conditions for generating a rule are met, proceed with the following steps:

1. Invoke the **rule-generating agent**:
   `.cursor/rules/core-rules/rule-generating-agent.mdc`.

2. Pass the following information to the rule-generating agent:
   - Structured reflection output (from the above analysis).
   - Generalized prevention principle.
   - Example of the failure and corresponding fix (before/after).
   - Scope boundaries (to ensure the rule’s scope is clear and reusable).

3. Save the newly generated rule in the `.cursor/rules/self_corrected_rules` folder.

   **Naming Convention**:
   Rules generated by this mechanism must follow the format:
   - `sc_<category>_<short-description>.mdc`

   **Example**:
   `sc_validation_require-null-checks.mdc`

4. If the rule’s scope overlaps with an existing rule in the **`self_corrected_rules`** folder, ensure the new rule **does not duplicate or contradict** existing logic.
   If there is an overlap, suggest merging the rules instead of creating a new one.

---

## Rule Quality Filter (Anti-Explosion)
Reject rule creation if any of the following are true:

- The rule **overlaps** with an existing rule **by > 70%**.
- The rule is **overly specific** to a single file or use case.
- The rule addresses a **one-time edge case** and does not have broader applicability.
- The rule is **stylistic** rather than structural (e.g., enforcing formatting or preference).
- The rule **contradicts an existing core rule**.

If an overlap is detected, suggest merging the rules instead of generating a new one.

---

## Cross-Folder Conflict Policy
If the self-correction workflow generates a rule that **conflicts** with any rule outside of `.cursor/rules/self_corrected_rules` (i.e., any rule in `.cursor/rules/core-rules` or `.cursor/rules/rules_for_self_correcting`):

- Do **NOT** automatically implement the rule.
- Produce a **"Conflict Resolution Suggestion"** and **ask for user approval** before proceeding with any modifications.

---

## Output Format When Triggered

### SELF-CORRECTION RULE PROPOSAL

When the self-correction workflow generates a new rule, the output must include the following:

- **Rule Name**:
- **Category**:
- **Why It’s Needed**:
- **Prevention Scope**:
- **Confidence**: (Include the percentage confidence)
- **Conflict Check Result**: (Did the rule conflict with another rule?)
- **Overlap Check Result**: (Did the rule overlap with existing rules?)

If there is a conflict or overlap, the output will be marked as:
- **"Suggestion Only – Awaiting Approval"**.

---

## Self-Correction Index
- The self-correction workflow will use `.cursor/rules/rules_for_self_correcting/self-correction-index.mdc` to track recurring bug categories and maintain a log of previously self-corrected issues.

- The **self-correction-index.mdc** tracks patterns that help identify **recurring problems** and prioritize rule creation for frequent failures.

---

## Conclusion
This self-correction mechanism enables the agent to learn from its past mistakes, progressively evolve to avoid repeating errors, and improve the overall reliability of the system. The workflow ensures that only **reusable, generalized prevention rules** are generated, preventing rule explosion while continuously improving the system’s quality.

---

### Folder Path Overview:
- **Rules governing self-correction** are located in: `.cursor/rules/rules_for_self_correcting`
- **Generated self-correction rules** are stored in: `.cursor/rules/self_corrected_rules`

---

This is the complete text for the `self-correction-controller.mdc` file. You can now copy-paste it into your document, and it should reflect all the changes you requested (moving the index file, respecting folder isolation, and ensuring clean rule management).